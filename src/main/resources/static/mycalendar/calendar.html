<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì›”ë³„ ë‹¬ë ¥</title>
<link rel="stylesheet" href="../css/myCalendarstyle.css" />
<link rel="stylesheet" href="../css/main.css">
</head>
<body>
	<!-- Header Section -->
	<div class="header">
		<div class="header-content">
			<div class="logo">
				<span class="home-btn" onclick="location.href='/'">ë¡œê³ </span> <span class="site-name">ê·¸ë¦°ë‹¤ì´ì–´ë¦¬(ì˜ˆëª…)</span>
			</div>
			<div class="nav-icons">
				<div class="nav-item">
					<div class="icon-box"></div>
					<span>ê¶ê¸ˆí•´?</span>
				</div>
				<div class="nav-item" onclick="location.href='/freeBoardList.do'">
					<div class="icon-box"></div>
					<span>ì»¤ë®¤ë‹ˆí‹°</span>
				</div>
				<div class="nav-item" onclick="location.href='/mydiary/list.do'">
					<div class="icon-box"></div>
					<span>ë‹¤ì´ì–´ë¦¬</span>
				</div>
				<div class="nav-item" onclick="location.href='/info.do'">
					<div class="icon-box"></div>
					<span>ì‹ë¬¼ë„ê°</span>
				</div>
			</div>
			<div class="user-section">
				<span class="login-link">ë¡œê·¸ì¸</span> <span class="register-link">íšŒì›ê°€ì…</span>
				<div class="user-icon">ğŸ‘¤</div>
			</div>
		</div>
	</div>

	<!-- í•œì´ ì‘ì—… -->
	<!-- 
		<nav>
			<a href="/mydiary/list.do">ë‹¤ì´ì–´ë¦¬</a>
		</nav>	
	 -->
	<h2>calendar</h2>
	<div class="calendar-container">
		<div class="calendar-controls">
			<button id="prev-month">â—€ ì´ì „ë‹¬</button>
			<div class="calendar-title" id="calendar-title"></div>
			<button id="next-month">ë‹¤ìŒë‹¬ â–¶</button>
			<button type="button" onclick="location.href='/mydiary/write.do';">ê¸€ì“°ê¸°</button>
		</div>
		<div class="calendar-header" id="calendar-header"></div>
		<div class="calendar-body" id="calendar-body"></div>
	</div>

</body>
</html>
<script type="module">
    import {
      startOfMonth,
      endOfMonth,
      startOfWeek,
      endOfWeek,
      addDays,
      format,
      isSameMonth,
      isToday,
      subMonths,
      addMonths
    } from "https://cdn.skypack.dev/date-fns@2.30.0";

    let currentDate = new Date(); 
    let posts = [];

	async function loadPosts(year, month){
	  const y = year;
	  const m = String(month + 1).padStart(2, "0"); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1

      const response = await fetch(`/calendar/images?year=${y}&month=${m}`);
        if (response.ok) {
		  // json í˜•ì‹: [{ postdate: '2025-08-04', imageUrl: '...' }, ...]
          posts = await response.json(); 
        } 
	    else {
    	  console.error("ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    	  posts = [];
   	  }
	}

    const header = document.getElementById("calendar-header");
    const body = document.getElementById("calendar-body");
    const title = document.getElementById("calendar-title");

    document.getElementById("prev-month").addEventListener("click", async () => {
      currentDate = subMonths(currentDate, 1);
      await renderAll();
    });

    document.getElementById("next-month").addEventListener("click", async () => {
      currentDate = addMonths(currentDate, 1);
      await renderAll();
    });

    function renderHeader() {
      header.innerHTML = "";
      ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
        const div = document.createElement('div');
        div.textContent = day;
        header.appendChild(div);
      });
    }

    function renderCalendar() {
      body.innerHTML = "";

      const monthStart = startOfMonth(currentDate);
      const monthEnd = endOfMonth(monthStart);
      const startDate = startOfWeek(monthStart, { weekStartsOn: 0 });
      const endDate = endOfWeek(monthEnd, { weekStartsOn: 0 });

      title.textContent = format(monthStart, "yyyyë…„ MMì›”");

      let day = startDate;
      while (day <= endDate) {
        const row = document.createElement('div');
        row.className = 'grid-row';

        for (let i = 0; i < 7; i++) {
          const formattedDate = format(day, 'yyyy-MM-dd');
          const cell = document.createElement('div');
          cell.className = 'calendar-cell';

          if (!isSameMonth(day, monthStart)) cell.classList.add('inactive');
          if (isToday(day)) cell.classList.add('today');

          const dateText = document.createElement('div');
          dateText.textContent = format(day, 'd');
          cell.appendChild(dateText);

		  //ì´ë¯¸ì§€ê°€ ìˆëŠ” ë‚ ì— ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ í•´ë‹¹ ë‚ ì§œì— ì¶”ê°€
          const post = posts.find(p => 
			format(new Date(p.postdate), 'yyyy-MM-dd') === formattedDate && p.imageUrl);
          if (post) {
            const img = document.createElement('img');
            img.src = `/uploads/${post.imageUrl}?v=${Date.now()}`;
            img.alt = "ì¸ë„¤ì¼";
            img.className = "thumbnail";
            cell.appendChild(img);
          }

          row.appendChild(cell);
          day = addDays(day, 1);
        }

        body.appendChild(row);
      }
    }

   	async function renderAll() {
	  await loadPosts(currentDate.getFullYear(), currentDate.getMonth());
      renderHeader();
      renderCalendar();
    }

    renderAll();
  </script>